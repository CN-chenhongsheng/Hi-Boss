# 持久化登录功能测试指南

## 快速开始

### 1. 重新编译小程序

```bash
cd miniprogram
pnpm dev:mp-weixin
```

打开微信开发者工具，导入项目。

---

## 测试清单

### ✅ 测试 1: 正常登录流程（基础功能）

**步骤:**
1. 打开小程序
2. 输入用户名和密码登录
3. 登录成功后，检查是否进入主页
4. 调用几个接口（如：获取个人信息、查看申请列表）

**预期结果:**
- ✅ 登录成功
- ✅ 接口调用正常
- ✅ 无 401 错误提示

---

### ✅ 测试 2: 关闭重开小程序（Token 持久化）

**步骤:**
1. 登录成功后，关闭小程序（完全退出）
2. 立即重新打开小程序

**预期结果:**
- ✅ 无需重新登录
- ✅ 直接进入主页
- ✅ 接口调用正常
- ✅ 用户信息正常显示

**说明:** Token 从本地存储恢复，有效期 30 天。

---

### ✅ 测试 3: 3 小时后重开小程序（超过旧的 2 小时限制）

**步骤:**
1. 登录成功后，关闭小程序
2. 等待 3 小时（或更长时间）
3. 重新打开小程序

**预期结果:**
- ✅ 无需重新登录
- ✅ 直接进入主页
- ✅ 接口调用正常
- ✅ **不再显示"Token 无效或已过期"错误**

**说明:** 这是主要修复的问题。现在 Token 有效期 30 天，3 小时后仍然有效。

---

### ✅ 测试 4: 模拟 Token 过期（错误处理优化）

**步骤:**
1. 登录成功后，使用 Redis 命令手动设置 Token 过期：
   ```bash
   redis-cli
   > KEYS "satoken:*"
   # 找到当前用户的 Token，例如：satoken:login:token:abc123
   > EXPIRE "satoken:login:token:abc123" 10
   > exit
   ```
2. 等待 10 秒
3. 在小程序中调用任意接口（如：刷新页面、获取数据）

**预期结果:**
- ✅ 显示 Toast 提示："登录已过期，请重新登录"
- ✅ 提示持续 2 秒
- ✅ 1.5 秒后自动跳转到登录页
- ✅ 用户体验友好，知道发生了什么

**说明:** 测试优化后的错误提示功能。

---

### ✅ 测试 5: Token 自动刷新（防循环机制）

**步骤:**
1. 登录成功后，使用 Redis 命令设置 Access Token 过期，但保留 Refresh Token：
   ```bash
   redis-cli
   > EXPIRE "satoken:login:token:abc123" 10
   # 不要删除 refresh token
   > exit
   ```
2. 等待 10 秒
3. 在小程序中调用任意接口

**预期结果:**
- ✅ 自动调用 refreshTokenAPI
- ✅ 更新 Token 成功
- ✅ 重新执行原请求
- ✅ 用户无感知，接口正常返回数据
- ✅ 无无限循环

**说明:** 测试 Token 自动刷新机制和防循环优化。

---

### ✅ 测试 6: 刷新失败多次（失败计数）

**步骤:**
1. 登录成功后，停止后端服务或清空 Redis
2. 在小程序中调用任意接口 3 次（快速点击）

**预期结果:**
- ✅ 第 1-2 次失败：显示"登录已过期，请重新登录"
- ✅ 第 3 次失败：显示"多次登录失败，请稍后重试"
- ✅ 跳转到登录页
- ✅ 失败计数正常工作

**说明:** 测试失败计数和不同错误提示。

---

### ✅ 测试 7: 主动登出

**步骤:**
1. 登录成功后，进入"我的"页面
2. 点击"退出登录"按钮

**预期结果:**
- ✅ 清除本地 Token
- ✅ 跳转到登录页
- ✅ 无错误提示（因为是主动操作）
- ✅ 重新打开小程序需要登录

**说明:** 测试主动登出功能。

---

### ✅ 测试 8: 30 天后 Token 过期

**步骤:**
1. 使用 Redis 命令模拟 30 天后：
   ```bash
   redis-cli
   > EXPIRE "satoken:login:token:abc123" 1
   > exit
   ```
2. 立即在小程序中调用接口

**预期结果:**
- ✅ 显示"登录已过期,请重新登录"
- ✅ 跳转到登录页
- ✅ 重新登录成功

**说明:** 模拟 30 天后的正常过期流程。

---

## Redis 验证命令

### 查看所有 Token
```bash
redis-cli
> KEYS "satoken:*"
```

### 查看 Token 剩余有效期
```bash
redis-cli
> TTL "satoken:login:token:xxx"
# 返回值：
# - 正数：剩余秒数（应接近 2592000，即 30 天）
# - -1：永不过期
# - -2：已过期或不存在
```

### 手动设置 Token 过期时间
```bash
redis-cli
> EXPIRE "satoken:login:token:xxx" 10  # 10 秒后过期
> EXPIRE "satoken:login:token:xxx" 1   # 1 秒后过期（模拟立即过期）
```

### 删除 Token（模拟刷新失败）
```bash
redis-cli
> DEL "satoken:login:token:xxx"
> DEL "satoken:login:session:xxx"
```

---

## 常见问题排查

### 问题 1: 仍然显示"Token 无效或已过期"

**可能原因:**
1. 后端服务未使用最新配置（30 天）
2. 使用的是旧 Token（2 小时有效期）

**解决方法:**
1. 检查后端日志，确认 Token 有效期：
   ```
   Sa-Token 配置如下:
   ...
   token 有效期: 2592000 秒
   ```
2. 清空 Redis，重新登录：
   ```bash
   redis-cli
   > FLUSHDB
   > exit
   ```

### 问题 2: 登录后立即跳转到登录页

**可能原因:**
1. Token 保存失败
2. 自动刷新机制触发异常

**解决方法:**
1. 检查小程序控制台日志
2. 检查 `userStore.setToken()` 是否正常调用
3. 检查本地存储中的 Token

### 问题 3: 刷新 Token 失败

**可能原因:**
1. Refresh Token 也过期了（7 天）
2. Redis 中的 Token 被清空

**解决方法:**
1. 检查 Redis 中的 Refresh Token：
   ```bash
   redis-cli
   > KEYS "satoken:*refresh*"
   > TTL "satoken:login:refresh-token:xxx"
   ```
2. 重新登录

### 问题 4: 无限循环调用 refreshTokenAPI

**可能原因:**
1. refreshTokenAPI 携带了 Authorization 头
2. 后端刷新接口返回 401

**解决方法:**
1. 检查 `miniprogram/src/api/auth/index.ts` 中的配置：
   ```typescript
   custom: {
     auth: false,  // 确保这一行存在
     skipErrorHandler: true,
   }
   ```
2. 检查后端刷新接口日志

---

## 成功标志

### ✅ 测试全部通过时，应该看到：

1. **登录一次后 30 天内无需重复登录**
2. **关闭小程序后重新打开，自动恢复登录状态**
3. **所有接口调用正常，无 401 错误**
4. **Token 过期时显示友好提示**
5. **刷新失败时不会无限循环**
6. **用户体验流畅，无感知刷新**

---

## 下一步

测试通过后：
1. ✅ 提交代码到 Git
2. ✅ 部署到测试环境
3. ✅ 通知用户测试
4. ✅ 收集反馈并优化

---

**测试指南版本:** v1.0
**创建日期:** 2026-02-01
